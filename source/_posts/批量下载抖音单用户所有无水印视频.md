---
title: ' 批量下载抖音单用户所有无水印视频    '
author: MuyanGit
avatar: 'https://cdn.jsdelivr.net/gh/muyangit/cdn@1.4/img/custom/avatar.jpg'
authorAbout: 尽小者大，甚微者著
authorDesc: 日就月将，学有缉熙于光明
categories: 技术
comments: true
date: 2021-10-20 02:53:45
authorLink:
tags: 加密
keywords:
description:
photos:
password: Id321cba
abstract: 这里有东西被加密了，需要输入密码查看哦。
message: 您好，这里需要密码。
wrong_pass_message: 抱歉，这个密码看着不太对，请再试试。
wrong_hash_message: 抱歉，这个文章不能被纠正，不过您还是能看看解密后的内容。
---

[[Python\]](https://www.52pojie.cn/forum.php?mod=forumdisplay&fid=24&filter=typeid&typeid=29) 【原创源码】【python】下载抖音无水印视频 ![评价指数 7](https://static.52pojie.cn/static/image/common/recommend_1.gif) [[复制链接\]](https://www.52pojie.cn/thread-1120994-1-1.html)

|      |      |
| ---- | ---- |
|      |      |

首先声明该方法仅供个人使用，严禁非法获利。
1.一般我们保存抖音视频，下载保存打开后视频上是有水印的，如下图：

![img](https://attach.52pojie.cn/forum/202003/02/164508b9zese8te8qzjq7p.jpg)


视频中会有水印，虽然网上也有各自去水印的方法，但是都是基于视频图像处理进行的，下面介绍的方法是从源头直接获取无水印视频下载链接。

2.首先我们在抖音分享里面，复制视频链接，例如：#在抖音，记录美好生活#我今年38，身高180，从来不洗澡，家里有八套房子，里面只有一件事情是真的，你猜是哪一件#twice问号舞 https://v.douyin.com/tPPT11/ 复制此链接，打开【抖音短视频】，直接观看视频！

3.以这个视频为例，复制这段内容里面的url链接：https://v.douyin.com/tPPT11/，可以看出来抖音视频都是以短链接的方式进行外链分享，我们把这个短链接用Chrome浏览器打开【注意】浏览器用F12开发者模式中，改为移动设备，如图： 

![img](https://attach.52pojie.cn/forum/202003/02/165052yi2111cir0oaq12p.png)



4.在开发者工具中过滤item，可以看到request请求url为：https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=6799201381799513359&dytk=cd3d594ff02fe56fca2568f82d659b939942bf444f1a974247d6bb6f526a2995
可以看出这里面每个视频的实际播放url的组成格式都是这样的，那么接下来就是要找到每个视频的item_ids和dykt。

![img](https://attach.52pojie.cn/forum/202003/02/165821z9c9dmaxducmmudz.png)



5.我们继续看过滤前的报文，里面有个document的报文，这里面就是我们打开短链接时获取的一个页面。里面包含了我们所需要的item_ids和dykt。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/170417safnzrhklkaqf0rc.png) 



![img](https://gitee.com/muyangit/blog-img/raw/master/img/170420vf9wmj8bwjbw662w.png)



6.OK通过上面操作我们已经获取到一个短视频的长链接所以要的2个参数，下面就是需要进行组装url，我们先打开url看看内容是什么。这其实就是一个Http请求，我们直接看回复的内容：

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200305681.png)



7.可以看到返回了多个addr。其中download_addr，下面标注了has_watermark:true，这是我们平常保存时候带水印的视频链接。
继续往下看，有一个play_addr，这个就是我们要找的无水印视频链接，复制到手机浏览器里打开，OK没有水印，大功告成！对比一下同一个时间点的视频截图：

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200304310.jpeg)



最后附上python代码：

[Python] *纯文本查看* *复制代码*

[?](https://www.52pojie.cn/#)

```
# Chrome用开发者模拟移动设备打开短链接  https://v.douyin.com/sLvq6P/
# 过滤item_ids字段和dytk字段，组装视频播放url
# 打开里面的play_addr，即可得到无水印视频播放地址，复制url到手机浏览器打开即得无水印视频
 
#视频播放长链接组装规则
# "https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?
#     item_ids="+item_ids[0]+"&dytk="+dytk[0]
 
import requests
import re
 
#设置浏览器代{过}{滤}理，一定要是移动设备，安卓/iOS均可
headers = {
"user-agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 13_2_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Mobile/15E148 Safari/604.1"
}
 
print("===>欢迎使用抖音视频去水印提取工具")
print("===>请输入抖音链接中的短链接（eg：https://v.douyin.com/sLvq6P/）")
input_url = input("===>")
#根据粘贴的分享内容，提取视频短链接
preurl = re.findall(r'(?<=douyin.com\/)\w+\/', input_url, re.I|re.M)
 
# print("https://v.douyin.com/"+preurl[0])
#组装短链接url
url = "https://v.douyin.com/"+preurl[0]
 
#请求短链接，获得itemId和dytk
get = requests.get(url, headers=headers)
html = get.content
# print(html)
itemId = re.findall(r"(?<=itemId:\s\")\d+", str(html))
# print(itemId[0])
dytk = re.findall(r"(?<=dytk:\s\")(.*?)(?=\")", str(html))
# print(dytk[0])
 
#组装视频长链接
videourl = "https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?\
item_ids="+itemId[0]+"&dytk="+dytk[0]
# print(videourl)
 
#请求长链接，获取play_addr
videoopen = requests.get(videourl, headers=headers)
vhtml = videoopen.text
# print(vhtml)
uri = re.findall(r'(?<=\"uri\":\")\w{32}(?=\")', str(vhtml))
# print(uri[0])
 
#长链接的格式其实是固定的，唯一变动的就是video_id，上面提取出uri后进行组装即可得到最终链接
play_addr = "https://aweme.snssdk.com/aweme/v1/play/?video_id="+uri[0]+\
            "&line=0&ratio=540p&media_type=4&vr_type=0&improve_bitrate=0&is_play_url=1&is_support_h265=0&source=PackSourceEnum_PUBLISH"
print("===>复制下面的长链接到手机浏览器打开即可得到无水印视频\n===>"+play_addr)
 
#自定义文件名保存短视频
name = input("===>正在下载保存视频,请输入视频名称：")
video = requests.get(url=play_addr, headers=headers)
with open(name+".mp4", 'wb')as file:
    file.write(video.content)
    file.close()
    print("===>视频下载完成！")
 
#完事后退出程序
input("===>press enter key to exit!")
```



实际运行一下，OK！

![img](https://gitee.com/muyangit/blog-img/raw/master/img/173116cjlxu6hpluk6jlgq.png)


新人首次发帖，如有错误之处请大佬指正！

## 使用说明

1. 获取用户主页分享链接：例如：在抖音，记录美好生活！ https://v.douyin.com/eSN7g1c/
2. 运行程序，把获得的分享链接复制进去
3. 下载！

# 思路

1. 根据用户页面分享的链接提取url
2. 根据url来进行请求，通过禁用重定向来获取headers['location'],再从中提取sec_id
3. **拼接该用户所有视频列表请求** **url，然后在下载保存即可。** **下面给出一个请求参数示例**

```
params = {
    'sec_uid' : 'MS4wLjABAAAAbtSlJK_BfUcuqyy8ypNouqEH7outUXePTYEcAIpY9rk', #每个用户不同
    'count' : '200', #每次请求返回视频list中视频条数，不建议太大
    'min_cursor' : '1612108800000',#用户视频开始时间，带毫秒的时间戳
    'max_cursor' : '1619251716404',#用户视频结束时间，带毫秒时间戳
    'aid' : '1128',#未知参数，可有可无
    '_signature' : 'PtCNCgAAXljWCq93QOKsFT7QjR' #签名值，直接从请求参数里面复制一个就能一直用
}
```



```
import requests
import json
import os
import time
import re
"""
1.根据用户页面分享的字符串提取短url
2.根据短url加上302获取location,提取sec_id
3.拼接视频列表请求url
params = {
    'sec_uid' : 'MS4wLjABAAAAbtSlJK_BfUcuqyy8ypNouqEH7outUXePTYEcAIpY9rk',
    'count' : '200',
    'min_cursor' : '1612108800000',
    'max_cursor' : '1619251716404',
    'aid' : '1128',
    '_signature' : 'PtCNCgAAXljWCq93QOKsFT7QjR'
    }
"""
headers = {
"user-agent": "Mozilla/5.0 (Linux; Android 6.0; Nexus 5 Build/MRA58N) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Mobile Safari/537.36"
}
# string  = '在抖音，记录美好生活！ https://v.douyin.com/ekkTsYw/'
string = input('粘贴分享链接：')
 
shroturl = re.findall('[a-z]+://[\S]+', string, re.I|re.M)[0]
print(shroturl)
startpage = requests.get(url=shroturl, headers=headers, allow_redirects=False)
location = startpage.headers['location']
sec_uid = re.findall('(?<=sec_uid=)[a-z，A-Z，0-9, _, -]+', location, re.M|re.I)[0]
getname = requests.get(url='https://www.iesdouyin.com/web/api/v2/user/info/?sec_uid={}'.format(sec_uid), headers=headers).text
userinfo = json.loads(getname)
name = userinfo['user_info']['nickname']
print(userinfo['user_info']['nickname'])
Path = name
if os.path.exists(path=Path) == False:
    os.mkdir(path=Path)
else:
    print('directory exist')
os.chdir(path=Path)
 
"""new function"""
year = ('2018','2019','2020','2021')
month = ('01','02','03','04','05','06','07','08','09','10','11','12')
timepool = [x+'-'+y+'-01 00:00:00' for x in year for y in month ]
print(timepool)
k = len(timepool)
for i in range(k) :
    if i < k-1 :
        print('begintime='+timepool[i])
        print('endtime='+timepool[i+1])
        beginarray = time.strptime(timepool[i], "%Y-%m-%d %H:%M:%S")
        endarray = time.strptime(timepool[i+1], "%Y-%m-%d %H:%M:%S")
        t1 = int(time.mktime(beginarray) * 1000)
        t2 = int(time.mktime(endarray) * 1000)
        print(t1,t2)
        params = {
            'sec_uid' : sec_uid,
            'count' : 200,
            'min_cursor' : t1,
            'max_cursor' : t2,
            'aid' : 1128,
            '_signature' : 'PtCNCgAAXljWCq93QOKsFT7QjR'
        }
        awemeurl = 'https://www.iesdouyin.com/web/api/v2/aweme/post/?'
        awemehtml = requests.get(url=awemeurl, params=params, headers=headers).text
        data = json.loads(awemehtml)
        # print(data)
        # print(type(data))
        awemenum = len(data['aweme_list'])
        print(awemenum)
        for i in range(awemenum):
            videotitle = data['aweme_list'][i]['desc'].replace("?", "").replace("\"","").replace(":","")
            videourl = data['aweme_list'][i]['video']['play_addr']['url_list'][0]
            start = time.time()
            print('{} ===>downloading'.format(videotitle))
            with open(videotitle+'.mp4', 'wb') as v:
                try:
                    v.write(requests.get(url=videourl, headers=headers).content)
                    end = time.time()
                    cost = end - start
                    print('{} ===>downloaded ===>cost {}s'.format(videotitle, cost))
                except Exception as e:
                    print('download error')
```







# [短视频（douyin+kuaishou）"去水印" 揍是这么简单。](https://segmentfault.com/a/1190000039287475)

[![img](https://avatar-static.segmentfault.com/125/902/12590288-5d8cf12ac38fd_huge128)**zz_jesse**](https://segmentfault.com/u/hahage)发布于 2 月 26 日

现在视频号非常火热，之前在做抖音和快手的人就直接把之前的视频直接搬运过来了。但是从抖音app下载的视频都是带官方水印的？这个是怎么去掉的？ 哦，不对，他们应该都有保留原视频的吧。但是还有很多人是直接搬运别人的视频的，那他们是怎么去水印的呢？

其实早就有很多现成的工具，如小程序、去水印app都能直接去水印，甚至还有收费的。

赶紧研究研究，说不准咱也能搞一个比他们更好的工具出来。

一顿操作猛如虎，各种抓包看数据，结果简单的不得了，分分钟内就能给一坨视频去水印。

其实这些去水印的工具都太夸张（忽悠）了，完全不是真的去水印，小白都以为是对视频做了什么牛逼的后处理，把水印干掉了。

其实是直接下载的无水印的视频而已。因为你在抖音和快手等app上，看到的视频都是不带官方水印，所以这个无水印视频肯定是存在的。

下面就把本人破解的过程一一说下（以douyin为例）。

# 1.先拿到第一个链接

![img](https://segmentfault.com/img/remote/1460000039287483)

# 2.嗯，在浏览器打开这个链接

然后打开刚才复制过来的地址，[https://v.douyin.com/e1MMESR/](https://link.segmentfault.com/?enc=KDArlKgJCedfugmt2yWTDA%3D%3D.c6Td2Xs4dCYA%2B9a%2BXFXwV8potJW%2FDYnHVIksBRyD5W8%3D) 。

# 3. 打开地址发现有302跳转

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200324850.png)

# 4.然后播放左侧的视频，竟然变成了带水印的视频。

我们在app里播放的看不到水印的，但是在浏览器打开就是有水印的。

![img](https://segmentfault.com/img/remote/1460000039287478)

# 5.在控制台发现有ajax请求，返回了该视频的全部信息，当然也包括视频地址

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200324920.png)

# 6.找到视频播放地址video.play_addr.url_list[0]

```awk
https://aweme.snssdk.com/aweme/v1/playwm/?video_id=v0300f760000c0fq7t5t1gvidv0rdtag&ratio=720p&line=0
```

上面这个地址和我们在控制台审查元素看到的video播放的是一个地址，但是都是带水印的地址。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200324601.png)

起码是一个信息，先把这个地址记录下来。

```awk
https://aweme.snssdk.com/aweme/v1/playwm/?video_id=v0300f760000c0fq7t5t1gvidv0rdtag&ratio=720p&line=0
```

# 7.另寻他路，从个人中心的视频列表入手

拿到个人的视频列表地址（进入个人中心点击分享，有复制链接）[https://v.douyin.com/e1MCMaT/](https://link.segmentfault.com/?enc=Dwwf%2BPrpm5vqxj5BqKgBKQ%3D%3D.2Xh8qt92o%2FBthHEn57OVMndzgkh5eDbab3HwG0iQuts%3D)。

# 8.浏览器打开，从控制台分析接口数据

这个就是接口返回的视频列表数据，不过也就是前几条，暂时还没看怎么拿到全部。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200324770.png)

# 9.列表数据分析，发现新大陆

上面接口返回了视频列表数据，这里每条数据的信息更丰富，而且发现了无水印地址。

每一个视频都有4个播放地址，估计是cdn，用来分流的，其实这就是无水印的播放地址。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200326045.png)

# 10.停止搜索，终点已到

上面的地址看上去内容差别挺大，依次打开后发现前两个都直接播放，后两个都有302跳转后播放。

再看下第三条地址，好像有点面熟

```awk
//第三条地址
https://aweme.snssdk.com/aweme/v1/play/?video_id=v0300f760000c0fq7t5t1gvidv0rdtag&line=0&ratio=720p&media_type=4&vr_type=0&improve_bitrate=0&is_play_url=1&source=PackSourceEnum_DOUYIN_REFLOW

//上面保存的
https://aweme.snssdk.com/aweme/v1/playwm/?video_id=v0300f760000c0fq7t5t1gvidv0rdtag&ratio=720p&line=0
```

很明显，地址一样几乎一模一样，只是参数不同。

参数可以忽略，就看地址差别在于`/playwm/`和`/play/`，差了个`wm`。

到这里，咱们算是大功告成了，去掉`wm`的就是无水印播放地址。`wm`是个啥？就是水印的英文简写`watermark`。

# 11.下载就完了

直接打开播放，在播放的视频上右键保存，完事儿。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110200324459.png)

本人后面也做很多测试，以上路子ok。

# 12.快手的怎么搞？

快手的就更简单了，完全没有隐藏，直接浏览器打开就是无水印的视频。明显抖音多做了一些。

# 搞个下载工具？

现在我们两步就可以下载到无水印视频了，但都是手动下载。所以我们要做成工具，直接输入视频地址就可以一键下载。

如何实现？手动下载很容易，但如果搞成自动的，就没那么顺利，因为平台早就意识到这个问题，也是做了防御的了。

下面有两个方案，最终的目标都是拿到视频的播放地址，然后下载视频。

## 实现方案A

走平台的api接口，拿到播放地址。不过很可能会遇到坑，平台应该早就对这种操作有方案，会被拒。

## 方案B

这个应该更简单，更有效，使用无头浏览器来拿到视频的地址。

## 部分代码

代码还么有写完整，只写了一个下视频和拿到api请求地址。

```qml
//下载视频

const path = require('path')
const fs = require('fs')
const request = require('request')
/**
 * 下载视频
 */
function downVideo(url) {
  var fileName = `${+new Date()}.mp4`
  var fullPath = path.resolve('./videos/' + fileName);
  console.log('开始下载视频：', fileName);
  request(encodeURI(url)).on('error', function (err) {
    console.log(error)
  }).pipe(fs.createWriteStream(fullPath)).on('finish', () => {
    console.log('视频下载成功');
  })

}

const url = 'http://v6-z.douyinvod.com/719423c89357069fffd503a6698436f9/60342b2c/video/tos/cn/tos-cn-ve-15/56505c3774bd46de98d6a49e2315e292/?a=1128&br=4996&bt=1249&cd=0%7C0%7C0&ch=0&cr=0&cs=0&cv=1&dr=0&ds=3&er=&l=2021022300074001020410813542130635&lr=&mime_type=video_mp4&pl=0&qs=0&rc=and1eWxqd3d0MzMzOWkzM0ApZTw2NWhoZGRpNzs7ZTc4OWcpaGRqbGRoaGRmXmEtYXMuMjRjYC0tNC0wc3MzLjY1XzMxNjE2Ly4xMDFhOmNwb2wrbStqdDo%3D&vl=&vr='
downVideo(url)
//获取api地址

function getApiUrl(url){
  //前端传过来的地址 进行重定向拿到 item_ids 并且返回
  return new Promise(resolve => {
    request(url, (error, response) => {
      if (!error && response.statusCode == 200) {
        let href = response.request.href;
        let id = '';
        id = href.match(/video\/(\S*)\/\?region/)[1];
        resolve(`https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=${id}`);
      } else {
        resolve(false)
      }
    })
  });
}

getApiUrl('xxx').then(api=>{
//xxx
})
```

后面会把代码补全，写一个完整的"去水印"工具，挂到我自己的站上。

# 最后下面分享个简单的方法。	

整个过程没什么难度，不过挺好玩。而且发现了很多有意思的东西，就上面那个视频列表内的信息很多很多，还可以挖掘一下。

市面上很多去水印工具，支持列表批量读取，这个怎么搞的，目前还没研究，知道的小伙伴可以留个言。

别看这件事儿对于程序员来说显得贼简单，但是不知道的人更多，你懂得。

接下来我要去搬运视频啦！！！








![image.png](https://gitee.com/muyangit/blog-img/raw/master/img/202110200328880.png)

打开浏览器控制台使用手机模式访问会跳转到 [https://www.iesdouyin.com/sha...](https://link.segmentfault.com/?enc=PtCwQ%2Bd2obOOh8zK0hfGbA%3D%3D.SCSCq0%2BP6XsNkMQomSgj0DJeXPKxner6VQVtO%2Fl5sitTkweVb24TZmCIijW8FA2MU4miJWhN6lVDdZOu%2FhiErA%3D%3D)
![image.png](https://gitee.com/muyangit/blog-img/raw/master/img/202110200328741.png)

可以看到请求接口 [https://www.iesdouyin.com/web...](https://link.segmentfault.com/?enc=l7IjIevWIGa7gIveJ%2BlLCw%3D%3D.BzdQX1kVRdSUZLg4RYqffVOJ3zcAFqS8vEm09gd%2BLx46zarNFEytKkqxNcD%2F0TXXVNXHxd4kqAUp6%2FY1mMXXQlVWZ9WnHvAHulIpdr%2BRbgJUkkN8iD18%2FB9VzBOQiSnN) ，返回值play_addr里就有播放地址url_list [https://aweme.snssdk.com/awem...](https://link.segmentfault.com/?enc=stkpxHO2K5ktjn9mIEpGdQ%3D%3D.neDdr1CdI3L1e%2FIIkKdJVXARp8yshPXK72gEcdQhEePvWGHPTTRVURKaQZuGJQZM4VoLDiCJMnOd7nY5lNr0qOh1TQuXKPjIr0tUzLZ9h65sEGYIb%2BzWmkeK7FfGiIm12ms50kFWTyMs4y4iO9vQaA%3D%3D)
这个地址是有水印的，将地址里的playwm改为play就是无水印播放地址了。

下载后播放对比下，左侧的抖音水印没了。
![image.png](https://gitee.com/muyangit/blog-img/raw/master/img/202110200328840.png)
无水印视频还少了3秒 ，因为视频结尾的一小段 `来抖音，发现更多创作者` 也没了。
![image.png](https://gitee.com/muyangit/blog-img/raw/master/img/202110200328962.png)

当然这样下载无水印视频有点麻烦，一般小白还不会，Python 可以帮你一键下载。

```javascript
url = input("请输入你要去水印的抖音短视频链接：")
 
response = requests.get('https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids='+str(vid))
result = response.json()
#print(result)
item = result.get("item_list")[0]
author = item.get("author").get("nickname")
mp4 = item.get("video").get("play_addr").get("url_list")[0]

with open(desc+".mp4", 'wb') as f, open(desc+".mp3", 'wb') as f2:
    f.write(video.content)
    f.close()
    f2.write(audio.content)
    f2.close()
    print("===>音频和视频下载完成")
```

直接执行脚本 python douyin.py ，很快下载好了。





# Python+cv2 视频转换为图片 与 图片转换为视频 - 简书

```python
import os
import cv2
from PIL import Image

def unlock_movie(path):
""" 将视频转换成图片
    path: 视频路径 """
  cap = cv2.VideoCapture(path)
  suc = cap.isOpened()  # 是否成功打开
  frame_count = 0
  while suc:
      frame_count += 1
      suc, frame = cap.read()
      params = []
      params.append(2)  # params.append(1)
      cv2.imwrite('frames\\%d.jpg' % frame_count, frame, params)

  cap.release()
  print('unlock movie: ', frame_count)


def  jpg_to_video(path, fps):
  """ 将图片合成视频. path: 视频路径，fps: 帧率 """
  fourcc = cv2.VideoWriter_fourcc(*"MJPG")
  images = os.listdir('frames')#os.listdir()方法用于返回指定的文件夹包含的文件或文件夹的名字的列表
  image = Image.open('frames/' + images[0])
  vw = cv2.VideoWriter(path, fourcc, fps, image.size)

os.chdir('frames')
for i in range(len(images)):
    # Image.open(str(image)+'.jpg').convert("RGB").save(str(image)+'.jpg')
    jpgfile = str(i + 1) + '.jpg'
    try:
        new_frame = cv2.imread(jpgfile)
        vw.write(new_frame)
    except Exception as exc:
        print(jpgfile, exc)
vw.release()
print(path, 'Synthetic success!')


if __name__ == '__main__':
  PATH_TO_MOVIES = os.path.join('test_movies', 'beautiful_mind2.mp4')
  PATH_TO_OUTCOME = os.path.join('detection_movies', 'beautiful_mind2_detection_1.avi')
  unlock_movie(PATH_TO_MOVIES)  # 视频转图片
  jpg_to_video(PATH_TO_OUTCOME, 24)  # 图片转视频
```







# 『异步反爬』别再说自己不会爬取『抖音』视频了！



# 『异步反爬』别再说自己不会爬取『抖音』视频了！

原创 李运辰 [Python研究者](javascript:void(0);) *3月16日*

收录于话题

\#反爬7个内容

\#爬虫45个内容

\#python76个内容

\#视频8个内容

![Python研究者](http://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibIiaAxjK0ruJVIWjuA9XKUW9oqEchJ6UDQacia8agMZwYtgIJpguR5R8ehYvhoCQUNc4eHEgic9zYGFQ/0?wx_fmt=png)

**Python研究者**

喜欢研究Python各种应用。包括但不仅限于爬虫，数据分析&可视化，自动化办公，以及开发日常生活工作中等小工具，回复【资料】领取Python学习大礼包。

108篇原创内容



公众号

1

前言



遇到『**异步反爬**』大家不知道怎么解决！今天就以『抖音』为实战案例，为大家讲解『异步反爬』应该怎么去处理！

同时也教大家怎么去爬取『**抖音**』视频，看完这篇文章，你以后不要再说：自己不会爬取抖音视频了！



2

准备工作

## 1.手机端操作

选择其中一个用户（家味美食），进入用户主页，然后点击右上角。

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22iaDbGD1PzB4IjVNlNYHWJZp0oT8qMZrHbzictBBEK21p2BhpibTCed4jg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



点击分享

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22Ribgd19KIWvkSzH4gL8taBPcdxaM07PKvt79GYQ0K3M7UUTbylJdibnA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



复制链接

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22aSFw4wKrOicLom4TEn8IC9icU54hAfgNEdziakuBSqHMXNibS44WjeSEjA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)





## 2.提取链接

提取好的链接如下：

```
https://v.douyin.com/e8g1kCq/
```





3

异步分析

## 1.查看数据包

从上面提取出来的链接是短链接，放到浏览器中运行则变成长链接

```
- https://v.douyin.com/e8g1kCq/
+ https://www.iesdouyin.com/share/user/77088058644?sec_uid=MS4wLjABAAAAumvAfskbDW1CB77yOudtt4ecmpi3Mkdm8XCkrTfRZPQ&did=70817958123&iid=2463339548275629&app=aweme&utm_campaign=client_share&utm_medium=ios&tt_from=copy&utm_source=copy
```





![image-20220717143328208](https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220717143328208.png)



找到下面这个数据包

```
https://www.iesdouyin.com/web/api/v2/aweme/post/?sec_uid=MS4wLjABAAAAumvAfskbDW1CB77yOudtt4ecmpi3Mkdm8XCkrTfRZPQ&count=21&max_cursor=0&aid=1128&_signature=q3mkJgAAyzVDo4ZbT2T9Cqt5pD&dytk=
```

## 2.分析链接

![image-20220717143248865](https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220717143248865.png)



分析链接分析，只有三个参数是需要改变的。

```
+ sec_uid（用户id）
+ count（返回数）最多是34
+ max_cursor（下一页）
```

## 3.获取数据

写代码之前先看一下获取的数据有哪些，将链接放到浏览器里去看一下。









![image-20220717143411693](https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220717143411693.png)

```
+ has_more 判断是否还有下一页
+ max_cursor 作为获取下一页标志
+ aweme_list 存放视频信息
```



![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22AFJQpZ35xJb3modn1VnquKFO5Xqic0wocdnPvcNyILZG8bIvVR5uZibg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



```
+ aweme_list列表中，desc是对应视频名称
+ video->play_addr->url_list存放着视频mp4地址
```



下面开始编程实现

```
headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 6.1; WOW64; rv:53.0) Gecko/20100101 Firefox/53.0",
        "Accept": "application/json,text/javascript,*/*; q=0.01",
        "Accept-Language": "zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3",
        "Accept-Encoding": "gzip,deflate, br",
        "X-Requested-With": "XMLHttpRequest",
        'Access-Control-Allow-Origin': '*',
        "Connection": "keep-alive"
    }
url = "https://www.iesdouyin.com/web/api/v2/aweme/post/?sec_uid="+str(sec_uid)+"&count="+str(count)+"&max_cursor="+str(max_cursor)+"&aid=1128&_signature=z1epBAAArxEnjYt5fPWXJs9XqR&dytk="
r = requests.get(url, headers=headers)
r.encoding = 'utf-8'
da = json.loads(r.text)
aweme_list  = da['aweme_list']
has_more = da['has_more']

for i in aweme_list:
    title = i['desc']
    video_url = i['video']['play_addr']['url_list'][0]
    print(title)
    print(video_url)
```



![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22VMBpsPUicbHLDfb4iaZPkSiaNWXeIoggM83xpwGicfjbMibSouRSRfm6RGg/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



## 4.下载视频到本地

```
###下载视频
def down(name,url):
    headers_down = {
        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3947.100 Safari/537.36',

    }
    r = requests.get(url,headers=headers_down)
    with open("lyc/"+str(name)+".mp4", 'wb+') as f:
        f.write(r.content)
```



定义了一个下载视频的函数，视频最终保存到lyc文件夹中。



![图片](https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/640)





4

获取下一页链接

## 1.下载视频到本地

![图片](https://mmbiz.qpic.cn/sz_mmbiz_png/mWFUNMBWzibKjXiaWNzSwJljmstCgZ2P22V3TYMONczQYcTrmgmfOa41eZmibj4iaxpCqIVJgRYILgHN7o4ZcCHibrw/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)

获取当前页请求返回的max_cursor，替换当前页的max_cursor。



![image-20220717143439203](https://cdn.jsdelivr.net/gh/MuyanGit/pic_url@master/img/image-20220717143439203.png)



```
while(has_more):
      url = "https://www.iesdouyin.com/web/api/v2/aweme/post/?sec_uid="+str(sec_uid)+"&count="+str(count)+"&max_cursor="+str(max_cursor)+"&aid=1128&_signature=z1epBAAArxEnjYt5fPWXJs9XqR&dytk="
      r = requests.get(url, headers=headers)
      r.encoding = 'utf-8'
      da = json.loads(r.text)
      aweme_list  = da['aweme_list']
      has_more = da['has_more']

      for i in aweme_list:
          title = i['desc']
          video_url = i['video']['play_addr']['url_list'][0]
          videotitle_list.append(title)
          down(title,video_url)
          print(title+"-下载完成！")
          videotitle_list = list(set(videotitle_list))
          print(len(videotitle_list))

          if has_more:
              max_cursor = da['max_cursor']
          else:
              break
```



5

总结













# 抖音下载解析

# 抖音

## 1·链接获取

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110221640016.png)

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110221640838.png)



得到类似分享链接：在抖音，记录美好生活！ https://v.douyin.com/eSN7g1c/

## 1·链接解析

Google Chrome Ctrl + Shift +I	开发者模式

输入并 https://v.douyin.com/eSN7g1c/回车键

选择比较长的Name【user_id``````】

response是折叠的----preview是可以逐级展开的

3.以这个视频为例，复制这段内容里面的url链接：https://v.douyin.com/tPPT11/，可以看出来抖音视频都是以短链接的方式进行外链分享，我们把这个短链接用Chrome浏览器打开【注意】浏览器用F12开发者模式中，改为移动设备，如图：

$\textcolor{Red}{	浏览器用F12开发者模式中，改为移动设备，}$

![image-20211022164433934](https://gitee.com/muyangit/blog-img/raw/master/img/202110221644161.png)



4.在开发者工具中过滤item，可以看到request请求url为：https://www.iesdouyin.com/web/api/v2/aweme/iteminfo/?item_ids=6799201381799513359&dytk=cd3d594ff02fe56fca2568f82d659b939942bf444f1a974247d6bb6f526a2995
可以看出这里面每个视频的实际播放url的组成格式都是这样的，那么接下来就是要找到每个视频的item_ids和dykt。

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110221713756.png)

1. Request URL: 

   

   https://www.iesdouyin.com/web/api/v2/aweme/post/?user_id=&sec_uid=MS4wLjABAAAALoWAiVO9nTCZdfJ2jESB05QUEcCeV5cdeYog8RVDPLA&count=21&max_cursor=0&aid=1128&uid=58116829755&_signature=SNpNfAAAKaph8.ieDAupSUjaTW&dytk=

   把请求头网址回车：--> 可见全部的视频列表

   ![image-20211022164751432](https://gitee.com/muyangit/blog-img/raw/master/img/202110221647552.png)

请求头分析 \\&       \n\&\n

```
Request URL: https://www.iesdouyin.com/web/api/v2/aweme/post/?user_id=
&
sec_uid=MS4wLjABAAAALoWAiVO9nTCZdfJ2jESB05QUEcCeV5cdeYog8RVDPLA
&
count=21	# 每次请求返回视频list中视频条数，不建议太大，默认21个，代码中200个
&
max_cursor=0
&
aid=1128	#未知参数，可有可无
&
uid=58116829755
&
_signature=Vb9-LQAANNB8lsvP0CImpVW.fj #签名值，直接从请求参数里面复制一个就能一直用
&
dytk=



1.根据用户页面分享的链接提取url2.根据url来进行请求，通过禁用重定向来获取headers['location'],再从中提取sec_id
3.拼接该用户所有视频列表请求url，然后在下载保存即可。下面给出一个请求参数示例：params = {
    'sec_uid' : 'MS4wLjABAAAAbtSlJK_BfUcuqyy8ypNouqEH7outUXePTYEcAIpY9rk', #每个用户不同
    'count' : '200', #每次请求返回视频list中视频条数，不建议太大
    'min_cursor' : '1612108800000',#用户视频开始时间，带毫秒的时间戳*1000-时间被放大1000倍
    'max_cursor' : '1619251716404',#用户视频结束时间，带毫秒的时间戳*1000-时间被放大1000倍
    'aid' : '1128',#未知参数，可有可无
    '_signature' : 'PtCNCgAAXljWCq93QOKsFT7QjR' #签名值，直接从请求参数里面复制一个就能一直用
}
```



5.我们继续看过滤前的报文，里面有个document的报文，这里面就是我们打开短链接时获取的一个页面。里面包含了我们所需要的item_ids和dykt

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110221712386.png)

找不到item_ids和dykt

1. _signature: 可以替换

   

   Vb9-LQAANNB8lsvP0CImpVW.fj

![image-20211022170644748](https://gitee.com/muyangit/blog-img/raw/master/img/202110221706012.png)



6.OK通过上面操作我们已经获取到一个短视频的长链接所以要的2个参数，下面就是需要进行组装url，我们先打开url看看内容是什么。这其实就是一个Http请求，我们直接看回复的内容：

![img](https://gitee.com/muyangit/blog-img/raw/master/img/202110221728951.png)







### 代码分析

#### startpage.headers['location']

![image-20211022174844996](https://gitee.com/muyangit/blog-img/raw/master/img/202110221748196.png)



startpage.headers['location']![image-20211022174629790](https://gitee.com/muyangit/blog-img/raw/master/img/202110221746957.png)

startpage.headers['location']

![image-20211022174536766](https://gitee.com/muyangit/blog-img/raw/master/img/202110221745983.png)



#### 获取sec_uid=

sec_uid = re.findall('(?<=sec_uid=)[a-z，A-Z，0-9, _, -]+', location, re.M | re.I)[0]

![sec_uid = re.findall('(?<=sec_uid=)[a-z，A-Z，0-9, _, -]+', location, re.M | re.I)[0]](https://gitee.com/muyangit/blog-img/raw/master/img/202110221750468.png)







#### 用户信息获取

![image-20211022175730394](https://gitee.com/muyangit/blog-img/raw/master/img/202110221757614.png)

![image-20211022175816111](https://gitee.com/muyangit/blog-img/raw/master/img/202110221758181.png)







##### 获取名字

![image-20211022180225821](https://gitee.com/muyangit/blog-img/raw/master/img/202110221802915.png)

![image-20211022180629610](https://gitee.com/muyangit/blog-img/raw/master/img/202110221806801.png)



时间戳转换\# 秒时间*1000--位移？？？

```
        # 秒时间*1000--位移？？？https://gitee.com/muyangit/blog-img/raw/master/img/202110221923700.png
        t1 = int(time.mktime(beginarray) * 1000)
        t2 = int(time.mktime(endarray) * 1000)
        print("t1: {t1Time}\n t2: {t2Time}".format(t1Time=t1, t2Time=t2))
```





![image-20211022192318856](https://gitee.com/muyangit/blog-img/raw/master/img/202110221923700.png)





```
        awemeurl = 'https://www.iesdouyin.com/web/api/v2/aweme/post/?'
        awemehtml = requests.get(url=awemeurl, params=params, headers=headers).text
```





新建时间池





数据库简表





> > > 1.获取抖音视频名称和真实mp4播放地址,解决『**异步反爬**』 问题
